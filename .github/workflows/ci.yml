name: Monorepo CI

on:
  push:
    branches: [ main ]
  pull_request:

env:
  CARGO_TERM_COLOR: always

jobs:
  rust-lints:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          components: rustfmt, clippy
      - name: Cargo fmt
        run: cargo fmt --all -- --check
      - name: Cargo clippy
        run: cargo clippy --workspace --all-targets --all-features -D warnings

  rust-tests:
    runs-on: ubuntu-latest
    needs: rust-lints
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
      - name: Cargo test (workspace)
        run: cargo test --workspace

  crypto-tests:
    runs-on: ubuntu-latest
    needs: rust-lints
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
      - name: Crypto tests
        run: cargo test -p synthetic-crypto

  circuits-proof:
    runs-on: ubuntu-latest
    needs: rust-lints
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
      - name: Transaction circuit tests
        run: cargo test -p transaction-circuit
      - name: Block circuit tests
        run: cargo test -p block-circuit
      - name: Prover benchmark smoke test
        run: cargo run -p circuits-bench -- --smoke --prove --json

  wallet:
    runs-on: ubuntu-latest
    needs: rust-lints
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
      - name: Wallet tests
        run: cargo test -p wallet
      - name: Wallet benchmark smoke test
        run: cargo run -p wallet-bench -- --smoke --json

  go-net:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: '1.21'
      - name: Go tests
        run: cd consensus/bench && go test ./...
      - name: Netbench smoke test
        run: cd consensus/bench && go run ./cmd/netbench --smoke --json

  cpp-style:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install clang-format
        run: sudo apt-get update && sudo apt-get install -y clang-format
      - name: clang-format --dry-run
        run: |
          set -euo pipefail
          FILES=$(git ls-files '*.cpp' '*.cc' '*.cxx' '*.hpp' '*.hh' '*.h')
          if [ -z "$FILES" ]; then
            echo "no C++ sources to lint"
            exit 0
          fi
          clang-format --dry-run --Werror $FILES

  benchmarks:
    runs-on: ubuntu-latest
    needs: [rust-tests, wallet, go-net]
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
      - uses: actions/setup-go@v5
        with:
          go-version: '1.21'
      - name: Circuits benchmark (smoke)
        run: cargo run -p circuits-bench -- --smoke --prove --json
      - name: Wallet benchmark (smoke)
        run: cargo run -p wallet-bench -- --smoke --json
      - name: Netbench (smoke)
        run: cd consensus/bench && go run ./cmd/netbench --smoke --json
