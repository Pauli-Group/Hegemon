name: Monorepo CI

on:
  push:
    branches: [ main ]
  pull_request:

env:
  CARGO_TERM_COLOR: always

jobs:
  rust-lints:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install build dependencies
        run: sudo apt-get update && sudo apt-get install -y protobuf-compiler libclang-dev
      - name: Setup Rust toolchain
        run: rustup show
      - name: Cargo fmt
        run: cargo fmt --all -- --check
      - name: Cargo clippy
        run: cargo clippy --workspace --all-targets -- -D warnings

  rust-tests:
    runs-on: ubuntu-latest
    needs: rust-lints
    steps:
      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force
          df -h
      - uses: actions/checkout@v4
      - name: Install build dependencies
        run: sudo apt-get update && sudo apt-get install -y protobuf-compiler libclang-dev
      - name: Setup Rust toolchain
        run: rustup show
      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: "rust-tests"
      - name: Cargo test (workspace)
        run: cargo test --workspace

  network-tests:
    runs-on: ubuntu-latest
    needs: rust-lints
    steps:
      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force
      - uses: actions/checkout@v4
      - name: Install build dependencies
        run: sudo apt-get update && sudo apt-get install -y protobuf-compiler libclang-dev
      - name: Setup Rust toolchain
        run: rustup show
      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: "network-tests"
      - name: Cargo test (network)
        run: cargo test -p network

  runtime-lints:
    runs-on: ubuntu-latest
    needs: rust-lints
    steps:
      - uses: actions/checkout@v4
      - name: Install build dependencies
        run: sudo apt-get update && sudo apt-get install -y protobuf-compiler libclang-dev
      - name: Setup Rust toolchain
        run: rustup show
      - name: Runtime clippy
        run: cargo clippy -p runtime --all-targets --all-features -- -D warnings

  runtime-build:
    runs-on: ubuntu-latest
    needs: runtime-lints
    steps:
      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force
      - uses: actions/checkout@v4
      - name: Install build dependencies
        run: sudo apt-get update && sudo apt-get install -y protobuf-compiler libclang-dev
      - name: Setup Rust toolchain
        run: rustup show
      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: "runtime-build"
      - name: Cargo build (runtime)
        run: cargo build -p runtime

  runtime-wasm:
    runs-on: ubuntu-latest
    needs: runtime-build
    steps:
      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force
      - uses: actions/checkout@v4
      - name: Install build dependencies
        run: sudo apt-get update && sudo apt-get install -y protobuf-compiler libclang-dev
      - name: Setup Rust toolchain
        run: rustup show
      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: "runtime-build"
      - name: Build node (includes WASM runtime)
        # Building the node triggers substrate-wasm-builder which properly
        # compiles the runtime for WASM with correct feature flags
        run: cargo build -p hegemon-node --release

  runtime-benchmarks:
    runs-on: ubuntu-latest
    needs: runtime-build
    steps:
      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force
      - uses: actions/checkout@v4
      - name: Install build dependencies
        run: sudo apt-get update && sudo apt-get install -y protobuf-compiler libclang-dev
      - name: Setup Rust toolchain
        run: rustup show
      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: "runtime-build"
      - name: Runtime benchmarks (smoke)
        run: cargo test -p runtime --features runtime-benchmarks -- --nocapture

  pallet-migrations:
    runs-on: ubuntu-latest
    needs: runtime-build
    steps:
      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force
      - uses: actions/checkout@v4
      - name: Install build dependencies
        run: sudo apt-get update && sudo apt-get install -y protobuf-compiler libclang-dev
      - name: Setup Rust toolchain
        run: rustup show
      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: "runtime-build"
      - name: Pallet migration tests
        run: cargo test -p runtime migration

  crypto-tests:
    runs-on: ubuntu-latest
    needs: rust-lints
    steps:
      - uses: actions/checkout@v4
      - name: Setup Rust toolchain
        run: rustup show
      - name: Crypto tests
        run: cargo test -p synthetic-crypto

  circuits-proof:
    runs-on: ubuntu-latest
    needs: rust-lints
    steps:
      - uses: actions/checkout@v4
      - name: Setup Rust toolchain
        run: rustup show
      - name: Transaction circuit tests
        run: cargo test -p transaction-circuit
      - name: Block circuit tests
        run: cargo test -p block-circuit
      - name: Prover benchmark smoke test
        run: cargo run -p circuits-bench -- --smoke --prove --json

  wallet:
    runs-on: ubuntu-latest
    needs: rust-lints
    steps:
      - uses: actions/checkout@v4
      - name: Setup Rust toolchain
        run: rustup show
      - name: Wallet tests
        run: cargo test -p wallet
      - name: Wallet benchmark smoke test
        run: cargo run -p wallet-bench -- --smoke --json

  security-adversarial:
    runs-on: ubuntu-latest
    needs: rust-tests
    env:
      PROPTEST_MAX_CASES: 64
    steps:
      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force
      - uses: actions/checkout@v4
      - name: Install build dependencies
        run: sudo apt-get update && sudo apt-get install -y protobuf-compiler libclang-dev
      - name: Setup Rust toolchain
        run: rustup show
      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: "rust-tests"
      - name: Transaction circuit security fuzzing
        run: cargo test -p transaction-circuit --test security_fuzz -- --nocapture
      - name: Network adversarial tests
        run: cargo test -p network --test adversarial -- --nocapture
      - name: Wallet address fuzzing
        run: cargo test -p wallet --test address_fuzz -- --nocapture
      - name: Cross-component adversarial flow
        run: cargo test --test security_pipeline -- --nocapture

  go-net:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: '1.21'
      - name: Go tests
        run: cd consensus/bench && go test ./...
      - name: Netbench smoke test
        run: cd consensus/bench && go run ./cmd/netbench --smoke --json

  node-wallet-flow:
    runs-on: ubuntu-latest
    needs: rust-tests
    steps:
      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force
      - uses: actions/checkout@v4
      - name: Install build dependencies
        run: sudo apt-get update && sudo apt-get install -y protobuf-compiler libclang-dev
      - name: Setup Rust toolchain
        run: rustup show
      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: "rust-tests"
      - name: Node + wallet integration test
        run: cargo test --test node_wallet_daemon -- --nocapture

  cpp-style:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: clang-format check
        run: |
          set -euo pipefail
          FILES=$(git ls-files '*.cpp' '*.cc' '*.cxx' '*.hpp' '*.hh' '*.h')
          if [ -z "$FILES" ]; then
            echo "no C++ sources to lint"
            exit 0
          fi
          clang-format --dry-run --Werror $FILES

  benchmarks:
    runs-on: ubuntu-latest
    needs: [rust-tests, wallet, go-net]
    continue-on-error: true
    steps:
      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force
      - uses: actions/checkout@v4
      - name: Install build dependencies
        run: sudo apt-get update && sudo apt-get install -y protobuf-compiler libclang-dev
      - name: Setup Rust toolchain
        run: rustup show
      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: "rust-tests"
      - uses: actions/setup-go@v5
        with:
          go-version: '1.21'
      - name: Circuits benchmark (smoke)
        run: cargo run -p circuits-bench -- --smoke --prove --json
      - name: Wallet benchmark (smoke)
        run: cargo run -p wallet-bench -- --smoke --json
      - name: Netbench (smoke)
        run: cd consensus/bench && go run ./cmd/netbench --smoke --json
