# Supply Chain Hardening: Go-between Dependency Sources

This ExecPlan is a living document. The sections `Progress`, `Surprises & Discoveries`, `Decision Log`, and `Outcomes & Retrospective` must be kept up to date as work proceeds.

Reference: repository root `.agent/PLANS.md` defines the ExecPlan format and maintenance requirements. Every update to this file must remain consistent with that guidance.

## Purpose / Big Picture

This plan hardens the dependency supply chain so that building the node and wallet no longer depends on live upstream sources. After this work, every dependency is pulled from a go-between source we control (forks for git repos and a vendored snapshot for crates), the build can run offline with `--locked`, and updates become explicit, auditable events rather than silent upstream drift. A user can clone the repo, run the normal setup, and then build and run the node without Cargo fetching from the public internet; if a dependency changes, it is visible in the mirror records and fails policy checks until explicitly approved.

The visible proof is that `cargo build --locked --offline` and the release workflows succeed using only the go-between sources, while attempts to introduce new upstream URLs or bypass the vendor mirror fail the supply-chain checks.

## Progress

- [x] (2025-12-20 03:01Z) Draft the supply-chain hardening ExecPlan.
- [ ] Produce a dependency inventory and define tiering policy (completed: none; remaining: all).
- [ ] Introduce go-between forks for git dependencies and pin them to immutable revisions (completed: none; remaining: all).
- [ ] Vendor crates.io dependencies and enforce source replacement (completed: none; remaining: all).
- [ ] Add supply-chain verification scripts and CI/release gating (completed: none; remaining: all).
- [ ] Update architecture, methods, and security docs to reflect the new policy (completed: none; remaining: all).
- [ ] Validate offline builds, dev node startup, and release artifacts (completed: none; remaining: all).

## Surprises & Discoveries

None yet. Update this section as soon as unexpected behavior is observed, with short evidence snippets.

## Decision Log

- Decision: Use organization-controlled forks for git dependencies and pin to `rev` (immutable commit), while recording the upstream tag for human context.
  Rationale: Tags can be retargeted; a commit hash is immutable and allows us to treat the fork as a true go-between source.
  Date/Author: 2025-12-20 / Codex

- Decision: Vendor crates.io dependencies into `vendor/` and use Cargo source replacement so all builds, including CI and releases, use the vendored snapshot by default.
  Rationale: Vendoring provides an auditable, offline-capable source of truth without requiring an external registry service to be live.
  Date/Author: 2025-12-20 / Codex

## Outcomes & Retrospective

Not yet complete. This section must be filled in as milestones are achieved, including what was delivered, what is still open, and any lessons learned.

## Context and Orientation

This repository is a Rust workspace with many Substrate/Polkadot dependencies pulled from `https://github.com/paritytech/polkadot-sdk` using a mutable tag. It also depends on crates.io for most other libraries. The workspace already commits `Cargo.lock`, and `.cargo/config.toml` currently only configures wasm build flags and test threading, with no supply-chain controls. CI and release workflows run `cargo build` without `--locked` or offline protections, so they can fetch new upstream content at build time.

In this plan, a "go-between fork" means a fork we control (for example in the Pauli Group organization) that mirrors an upstream repository. A "vendored snapshot" means a local copy of crates.io dependencies generated by `cargo vendor`, stored inside the repo, and referenced via Cargo source replacement. A "dependency tier" is a risk classification; Tier 1 includes libraries that affect consensus, cryptography, networking, key handling, or proof verification, and requires the strongest control (forks and explicit review). A "source replacement" is a Cargo configuration that forces crate downloads to come from a local directory rather than the public registry.

Key files and locations that will change include `Cargo.toml` (workspace dependency URLs), `Cargo.lock`, `.cargo/config.toml`, new scripts under `scripts/`, new policy documentation under `docs/`, and the CI workflows in `.github/workflows/`.

## Plan of Work

### Milestone 1: Inventory dependencies and define the tiering policy

Create a canonical policy document at `docs/SUPPLY_CHAIN.md` that defines the threat being addressed, the meaning of "go-between fork" and "vendored snapshot," the dependency tier definitions, and the approval process for introducing or updating dependencies. The document must include an explicit Tier 1 list derived from the current workspace: all Substrate/Polkadot crates (the `sp-*`, `sc-*`, `frame-*`, `pallet-*`, and `substrate-*` dependencies in the workspace), proof system crates (Winterfell and any proof-related crates), cryptographic primitives (`blake3`, `sha2`, `sha3`, `chacha20poly1305`, `rand`, and any PQ-specific crates), and network-transport crates. If the list is long, note in the document that it is generated from `Cargo.lock` and update it in the same commit as any dependency changes.

Add a small script at `scripts/dependency-inventory.sh` that prints a deterministic inventory of dependencies from `Cargo.lock`, grouping by registry source and git source. The script should emit a stable text file (for example `artifacts/deps-inventory.txt`) so reviewers can diff changes when dependencies move between tiers or sources. The script must run without network access.

### Milestone 2: Go-between forks and immutable git pinning

Fork or mirror every git dependency into an organization-controlled repository and update `Cargo.toml` to use those fork URLs instead of upstream. In practice, this is at least the Polkadot SDK repository, because the workspace currently pulls all Substrate crates from `paritytech/polkadot-sdk`. Replace the mutable `tag = "polkadot-stable2512-rc1"` with an immutable `rev = "<commit>"` that corresponds to the forked commit, and record the upstream tag in a comment so humans can map the commit back to the published release.

Add a new `config/dependency-sources.toml` file that records each fork mapping (upstream URL, mirror URL, pinned commit, upstream tag or release, and the date of last sync). This file is the system of record for go-between forks. Add a script at `scripts/update-git-mirrors.sh` that, given the upstream URL and mirror URL in that config file, fetches upstream, fast-forwards the mirror, updates the `rev` in `Cargo.toml`, and refreshes `Cargo.lock` in a single operation. The script should print the before/after commit hashes and require explicit confirmation to proceed.

### Milestone 3: Vendor crates.io and enforce source replacement

Run `cargo vendor --locked` to create a `vendor/` directory at the repository root and commit it. Update `.cargo/config.toml` so `[source.crates-io]` is replaced with a `vendored-sources` definition that points to `vendor/`. This change must not remove the existing wasm and test-thread settings; it should extend the file.

Add `scripts/vendor-deps.sh` to regenerate the vendor directory from `Cargo.lock`, and `scripts/verify-vendor.sh` to verify that `cargo build --locked --offline` succeeds for the workspace. `scripts/verify-vendor.sh` should be the canonical offline build check, and it must fail fast if the vendor directory is missing or stale.

### Milestone 4: Supply-chain verification and CI/release gating

Introduce `deny.toml` for `cargo-deny` with explicit allowlists for licenses and sources, and disallow any git sources that are not listed in `config/dependency-sources.toml`. Add `scripts/verify-supply-chain.sh` to run `cargo deny check` (including advisories), run the dependency inventory script, and ensure `.cargo/config.toml` enforces the vendored source replacement. Add a `scripts/verify-locked.sh` helper that fails if `Cargo.lock` is missing or if any workspace `Cargo.toml` uses a mutable git reference (tag or branch).

Update `.github/workflows/ci.yml` and `.github/workflows/release.yml` to run the new supply-chain checks and to build with `--locked --offline`. The release workflow should include the dependency inventory artifact (or the `config/dependency-sources.toml` file) in the release assets so downstream auditors can verify the exact dependency set used.

### Milestone 5: Documentation updates and operational guidance

Update `DESIGN.md` and `METHODS.md` to explain the supply-chain hardening approach and the operational steps for updating dependencies. Update `SECURITY.md` and `docs/THREAT_MODEL.md` with a short section describing the go-between fork policy, vendoring, and offline build requirement. If a contributor guide exists (`docs/CONTRIBUTING.md`), add a short "Dependency Update" section that points to the scripts introduced above and clarifies that dependency updates require refreshing `Cargo.lock`, `vendor/`, and the mirror records in the same change.

## Concrete Steps

All commands below assume the working directory is the repository root.

Fresh clone prerequisites (must run before any build on a new machine):

    make setup
    make node

Dependency inventory:

    ./scripts/dependency-inventory.sh

Go-between fork update (for example, after syncing the Polkadot SDK mirror):

    ./scripts/update-git-mirrors.sh

Vendor generation and offline build verification:

    ./scripts/vendor-deps.sh
    ./scripts/verify-vendor.sh

Supply-chain policy checks:

    ./scripts/verify-supply-chain.sh

Dev node sanity check after the changes:

    HEGEMON_MINE=1 ./target/release/hegemon-node --dev --tmp

Expected output examples should be added to this section as each milestone is implemented, using short indented transcripts.

## Validation and Acceptance

Acceptance is observable: the workspace builds with `cargo build --locked --offline` using only the vendored sources, the CI and release workflows run with `--locked --offline` and pass the supply-chain checks, and any attempt to add a new dependency without updating the mirror records and vendor snapshot fails `scripts/verify-supply-chain.sh`. The Polkadot SDK dependencies resolve to the organization-controlled fork at a pinned commit, not the upstream repository or a mutable tag. The dev node starts normally after the change, proving that the supply-chain protections do not break runtime behavior.

## Idempotence and Recovery

The vendor generation and verification scripts are safe to rerun; they should produce identical output when `Cargo.lock` has not changed. If a dependency update is rejected or proves unstable, roll back by restoring the previous `Cargo.toml` commit hashes, `Cargo.lock`, and `vendor/` directory from version control. The mirror update script must leave the repository unchanged if it fails to fast-forward or if confirmation is not granted.

## Artifacts and Notes

Example `config/dependency-sources.toml` entry:

    [git.polkadot_sdk]
    upstream = "https://github.com/paritytech/polkadot-sdk"
    mirror = "https://github.com/Pauli-Group/polkadot-sdk"
    rev = "0123456789abcdef0123456789abcdef01234567"
    upstream_tag = "polkadot-stable2512-rc1"
    last_sync = "2025-12-20"
    reviewer = "release-manager"

Example offline build proof:

    $ cargo build --locked --offline
    Finished release [optimized] target(s) in 2m 14s

Add real transcripts here as milestones are completed.

## Interfaces and Dependencies

The go-between configuration must be explicit and stable. `config/dependency-sources.toml` is the canonical map of upstream to mirror sources and must be updated for every git dependency update. `scripts/update-git-mirrors.sh` should parse that file and update `Cargo.toml` in place so every Substrate dependency uses the mirror URL and a pinned `rev`.

In `.cargo/config.toml`, add a crates.io source replacement without removing existing settings. The minimum required entries are:

    [source.crates-io]
    replace-with = "vendored-sources"

    [source.vendored-sources]
    directory = "vendor"

`scripts/verify-locked.sh` must reject any `Cargo.toml` git dependency that uses `tag` or `branch` instead of `rev`, because immutable pins are required for supply-chain safety. `scripts/verify-supply-chain.sh` must run `cargo deny check` using `deny.toml` and fail if any dependency source is not on the allowlist described in `docs/SUPPLY_CHAIN.md`.
